<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iyal | Dynamic Product Sales</title>
    
<script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FAF0E6; /* Linen Cream Background */
            color: #1a1a1a;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
        }

        body.overflow-hidden {
            overflow: hidden !important;
        }

        .snap-section {
            position: relative;
            scroll-snap-align: start;
            scroll-margin-top: 200px; 
        }

        #hero-section, #contact-section {
            height: 100vh;
        }

        #product-slides {
            min-height: 100vh; 
            height: auto; 
            padding-bottom: 15vh;
        }
        
        #hero-section {
            background-color: #4A352D; /* Deep Espresso */
        }

        #product-detail-page, #cart-page, #order-history-page {
            display: none;
            min-height: calc(100vh - 80px); /* 80px for header */
            padding-top: 80px; 
        }
        
        .hidden-page {
            display: none !important;
        }

        .star-filled {
            color: #FFC300;
        }
        .star-empty {
            color: #ddd;
        }
        
        .buy-button-style {
            transition: all 0.3s ease;
        }
        
        /* Mobile Menu Transition */
        #mobile-menu {
            transition: transform 0.3s ease-in-out;
        }

        /* Loading Animation */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #4A352D;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1s ease-out, visibility 1s;
        }
        #loading-overlay.hidden-load {
            opacity: 0;
            visibility: hidden;
        }
        .intro-char {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            display: inline-block;
        }
        .intro-char.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Modal Transition */
        #auth-modal {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #auth-modal.active {
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay">
        <div id="iyal-intro-text" class="text-white text-5xl font-bold tracking-wider">
            <span class="intro-char">I</span><span class="intro-char">y</span><span class="intro-char">a</span><span class="intro-char">l</span>
        </div>
    </div>

    <header id="main-header" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 py-4 px-6 md:px-12">
        <div class="flex items-center justify-between">
            <a href="javascript:void(0)" onclick="goHome()" class="text-3xl font-extrabold text-white tracking-widest transition duration-300 hover:text-[#B38B6D]">IYAL</a>
            
            <nav class="hidden md:flex space-x-8 text-white font-semibold">
                <a href="javascript:void(0)" onclick="goHomeAndScroll(1)" class="hover:text-[#B38B6D] transition">Products</a>
                <a href="javascript:void(0)" onclick="goHomeAndScroll(2)" class="hover:text-[#B38B6D] transition">About Us</a>
                <a href="javascript:void(0)" onclick="viewOrderHistory()" class="hover:text-[#B38B6D] transition">Orders</a>
                <a href="javascript:void(0)" onclick="goHomeAndScroll(3)" class="hover:text-[#B38B6D] transition">Contact</a>
            </nav>
            
            <div class="flex items-center space-x-6">
                
                <span id="current-user-status" class="hidden lg:block text-sm text-gray-300">Initializing...</span>
                
                <button id="auth-action-button" class="hidden md:block px-4 py-2 bg-[#B38B6D] text-white rounded-full text-sm font-semibold hover:bg-[#9E785C] transition shadow-md" onclick="showLoginModal()">Login / Sign Up</button>
                
                <button id="signout-button" class="hidden md:block px-4 py-2 bg-red-600 text-white rounded-full text-sm font-semibold hover:bg-red-700 transition shadow-md" onclick="signOutUser()">Sign Out</button>

                <button onclick="viewCart()" class="relative text-white hover:text-[#B38B6D] transition">
                    <svg id="cart-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-cart"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    <span id="cart-count" class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 text-xs bg-red-600 rounded-full w-5 h-5 flex items-center justify-center font-bold hidden">0</span>
                </button>
                
                <button id="mobile-menu-toggle" onclick="toggleMobileMenu()" class="md:hidden text-white hover:text-[#B38B6D] transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
            </div>
        </div>
    </header>

    <div id="mobile-menu" class="fixed top-0 right-0 h-full w-64 bg-[#4A352D] text-white shadow-xl z-50 transform translate-x-full pt-20">
        <nav class="flex flex-col space-y-4 p-6 font-semibold border-b border-gray-700">
            <a href="javascript:void(0)" onclick="goHomeAndScroll(1)" class="hover:text-[#B38B6D] transition text-lg">Products</a>
            <a href="javascript:void(0)" onclick="goHomeAndScroll(2)" class="hover:text-[#B38B6D] transition text-lg">About Us</a>
            <a href="javascript:void(0)" onclick="viewOrderHistory()" class="hover:text-[#B38B6D] transition text-lg">Orders</a>
            <a href="javascript:void(0)" onclick="goHomeAndScroll(3)" class="hover:text-[#B38B6D] transition text-lg">Contact</a>
        </nav>
        
        <div class="p-6">
            <button id="mobile-auth-button" onclick="handleMobileAuthAction()" class="w-full py-2 bg-[#B38B6D] text-white rounded-full text-md font-semibold hover:bg-[#9E785C] transition shadow-md">
                <span id="mobile-auth-text">Login / Sign Up</span>
            </button>
            <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-700">
                <span class="text-gray-300 font-semibold">Cart</span>
                <button onclick="viewCart()" class="relative text-white hover:text-[#B38B6D] transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-cart"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    <span id="mobile-cart-count" class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 text-xs bg-red-600 rounded-full w-5 h-5 flex items-center justify-center font-bold">0</span>
                </button>
            </div>
        </div>
    </div>

    <main id="main-content">

        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]" onclick="if(event.target === this) hideLoginModal()">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300">
                <h2 id="auth-title" class="text-3xl font-bold text-[#4A352D] mb-6 text-center">Login</h2>
                
                <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                    <span id="auth-error-message" class="block sm:inline"></span>
                </div>

                <form id="auth-form" onsubmit="event.preventDefault(); handleAuthSubmit();">
                    <div class="mb-4">
                        <label for="auth-email" class="block text-gray-700 font-medium mb-2">Email</label>
                        <input type="email" id="auth-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-[#B38B6D]/50 focus:border-[#B38B6D]" required>
                    </div>
                    <div class="mb-6">
                        <label for="auth-password" class="block text-gray-700 font-medium mb-2">Password</label>
                        <input type="password" id="auth-password" minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-[#B38B6D]/50 focus:border-[#B38B6D]" required>
                    </div>
                    <button id="auth-submit-button" type="submit" class="w-full bg-[#B38B6D] text-white py-3 rounded-xl font-bold text-lg hover:bg-[#9E785C] transition shadow-lg">Login</button>
                </form>
                
                <div class="text-center mt-4">
                    <button id="auth-toggle-button" onclick="toggleAuthMode()" class="text-[#4A352D] text-sm hover:text-[#B38B6D] transition underline">New user? Click here to **Sign Up**</button>
                </div>
            </div>
        </div>

        <div id="main-landing-content">
            
            <section id="hero-section" class="snap-section flex items-center justify-center text-white p-8">
                <div class="text-center max-w-4xl">
                    <h1 class="text-6xl md:text-8xl font-extrabold mb-4 leading-tight">Authentic Indian Ayurveda</h1>
                    <p class="text-xl md:text-2xl mb-8 font-light tracking-wide">Timeless remedies, made with pure intent. From our family farm to your home.</p>
                    <button onclick="scrollToSection(1)" class="px-8 py-4 bg-[#B38B6D] text-white rounded-full text-lg font-semibold hover:bg-[#9E785C] transition transform hover:scale-105 shadow-xl">Shop Our Products</button>
                </div>
            </section>

            <section id="product-slides" class="snap-section bg-FAF0E6 py-16">
                <h2 class="text-4xl md:text-5xl font-bold text-center text-[#4A352D] mb-12">Our Bestsellers</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 max-w-7xl mx-auto px-6">
                    
                    <div class="bg-white rounded-xl shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                        <img src="https://i.imgur.com/csiEy92.jpeg" alt="Magical Hair Oil" class="w-full h-64 object-cover">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-[#4A352D] mb-2">Magical Hair Oil 100ml</h3>
                            <p class="text-gray-500 mb-4">Potent blend of 12 herbs for hair growth.</p>
                            <div class="flex justify-between items-center">
                                <span class="text-3xl font-extrabold text-[#4A352D]">₹200</span>
                                <button onclick="viewProduct('oil_magic')" class="px-4 py-2 bg-[#B38B6D] text-white rounded-full font-semibold hover:bg-[#9E785C] transition">View Details</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                        <img src="https://i.imgur.com/zGVglzS.jpeg" alt="Iyal Face Pack" class="w-full h-64 object-cover">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-[#4A352D] mb-2">Glowing Face Pack 100g</h3>
                            <p class="text-gray-500 mb-4">Volcanic clay & charcoal for deep cleansing.</p>
                            <div class="flex justify-between items-center">
                                <span class="text-3xl font-extrabold text-[#4A352D]">₹175</span>
                                <button onclick="viewProduct('face_pack')" class="px-4 py-2 bg-[#B38B6D] text-white rounded-full font-semibold hover:bg-[#9E785C] transition">View Details</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                        <img src="https://i.imgur.com/idQyo02.png" alt="Iyal Health Mix" class="w-full h-64 object-cover">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-[#4A352D] mb-2">Iyal Health Mix 250g</h3>
                            <p class="text-gray-500 mb-4">18 roasted grains and nuts. Daily nutrition.</p>
                            <div class="flex justify-between items-center">
                                <span class="text-3xl font-extrabold text-[#4A352D]">₹350</span>
                                <button onclick="viewProduct('health_mix')" class="px-4 py-2 bg-[#B38B6D] text-white rounded-full font-semibold hover:bg-[#9E785C] transition">View Details</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                        <img src="https://i.imgur.com/sNIxEtX.jpeg" alt="Iyal Pain Relief Oil" class="w-full h-64 object-cover">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-[#4A352D] mb-2">Pain Relief Oil 100ml</h3>
                            <p class="text-gray-500 mb-4">Remedy for muscle and joint pain.</p>
                            <div class="flex justify-between items-center">
                                <span class="text-3xl font-extrabold text-[#4A352D]">₹150</span>
                                <button onclick="viewProduct('oil_pain')" class="px-4 py-2 bg-[#B38B6D] text-white rounded-full font-semibold hover:bg-[#9E785C] transition">View Details</button>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <section id="about-section" class="snap-section bg-[#4A352D] text-white py-16">
                <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                    <div>
                        <h2 class="text-4xl md:text-5xl font-bold mb-6">Our Commitment to Purity</h2>
                        <p class="text-lg mb-4">**Iyal** is not just a brand; it's a promise inherited through generations. We source our ingredients directly from our organic family farm in the foothills of the Western Ghats, ensuring every batch is free from chemicals, preservatives, and artificial additives.</p>
                        <p class="text-lg mb-6">We blend ancient Ayurvedic wisdom with modern, ethical processing to bring you products that are both effective and pure. When you choose Iyal, you choose wellness, tradition, and uncompromising quality.</p>
                        <button onclick="goHomeAndScroll(3)" class="px-6 py-3 bg-[#B38B6D] text-white rounded-full font-semibold hover:bg-[#9E785C] transition transform hover:scale-105">Read Our Story</button>
                    </div>
                    <div class="hidden md:block">
                        <img src="https://i.imgur.com/qTWeF4b.jpeg" alt="Iyal Farmhouse" class="rounded-xl shadow-2xl">
                    </div>
                </div>
            </section>

            <section id="contact-section" class="snap-section bg-FAF0E6 py-16 flex items-center justify-center">
                <div class="max-w-xl mx-auto p-8 bg-white rounded-xl shadow-2xl">
                    <h2 class="text-4xl font-bold text-[#4A352D] mb-6 text-center">Get In Touch</h2>
                    <p class="text-center text-gray-600 mb-8">Have a question or feedback? We'd love to hear from you.</p>
                    <form onsubmit="event.preventDefault(); alert('Thank you for your message! We will be in touch soon.');">
                        <div class="mb-4">
                            <label for="name" class="block text-gray-700 font-medium mb-2">Name</label>
                            <input type="text" id="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-[#B38B6D]/50 focus:border-[#B38B6D]" required>
                        </div>
                        <div class="mb-4">
                            <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                            <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-[#B38B6D]/50 focus:border-[#B38B6D]" required>
                        </div>
                        <div class="mb-6">
                            <label for="message" class="block text-gray-700 font-medium mb-2">Message</label>
                            <textarea id="message" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-[#B38B6D]/50 focus:border-[#B38B6D]" required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-[#B38B6D] text-white py-3 rounded-xl font-bold text-lg hover:bg-[#9E785C] transition shadow-lg">Send Message</button>
                    </form>
                </div>
            </section>
        </div>

        <div id="product-detail-page" class="bg-FAF0E6 py-10">
            <div class="max-w-7xl mx-auto px-6">
                <button onclick="goHome()" class="text-gray-600 hover:text-[#4A352D] mb-6 flex items-center transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left mr-2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Back to Products
                </button>
                <div class="bg-white p-8 rounded-xl shadow-2xl grid grid-cols-1 lg:grid-cols-2 gap-12">
                    
                    <div>
                        <img id="detail-image" src="" alt="Product Image" class="w-full h-auto object-cover rounded-xl shadow-lg border border-gray-100">
                    </div>
                    
                    <div>
                        <h1 id="detail-title" class="text-5xl font-extrabold text-[#4A352D] mb-4"></h1>
                        
                        <div id="detail-rating-display" class="flex items-center mb-6">
                            <span class="text-gray-500 ml-2"> (See <span id="detail-review-count">0</span> reviews)</span>
                        </div>
                        
                        <p id="detail-description" class="text-gray-700 text-lg mb-6 leading-relaxed"></p>
                        
                        <div class="flex justify-between items-center mb-8 border-t border-b py-4">
                            <span id="detail-price" class="text-4xl font-extrabold text-red-600">₹0.00</span>
                            <span id="detail-stock" class="text-lg font-medium"></span>
                        </div>
                        
                        <div class="space-y-3 mb-8">
                            <p class="flex items-center text-gray-700"><span class="font-semibold w-24">Delivery:</span> <span id="detail-delivery"><span>3-5 business days</span></span></p>
                            <p class="flex items-center text-gray-700"><span class="font-semibold w-24">SKU:</span> <span id="detail-sku">IYAL-001</span></p>
                        </div>
                        
                        <button onclick="addToCart(currentProductId)" class="buy-button-style w-full bg-[#B38B6D] text-white py-4 rounded-xl font-bold text-xl hover:bg-[#9E785C] transition shadow-lg">Add to Cart</button>
                    </div>

                    <div class="lg:col-span-2 mt-12">
                        <h3 class="text-3xl font-bold text-[#4A352D] mb-6 border-b pb-2">Product Specifications</h3>
                        <ul id="detail-specs" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 list-disc list-inside">
                            </ul>
                    </div>

                    <div class="lg:col-span-2 mt-8">
                        <h3 class="text-3xl font-bold text-[#4A352D] mb-6 border-b pb-2">Customer Reviews</h3>
                        
                        <div id="detail-reviews-list" class="space-y-6 mb-10">
                            </div>

                        <div class="p-6 border border-gray-200 rounded-xl bg-gray-50">
                            <h4 class="text-2xl font-bold text-[#4A352D] mb-4">Write a Review</h4>
                            <form onsubmit="handleReviewSubmit(event)">
                                <div class="mb-4">
                                    <label for="review-name" class="block text-gray-700 font-medium mb-2">Your Name</label>
                                    <input type="text" id="review-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                </div>
                                <div class="mb-4">
                                    <label for="review-rating" class="block text-gray-700 font-medium mb-2">Rating (1-5)</label>
                                    <input type="number" id="review-rating" min="1" max="5" class="w-20 px-4 py-2 border border-gray-300 rounded-lg" required>
                                </div>
                                <div class="mb-6">
                                    <label for="review-comment" class="block text-gray-700 font-medium mb-2">Your Review</label>
                                    <textarea id="review-comment" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></textarea>
                                </div>
                                <button type="submit" class="px-6 py-3 bg-[#4A352D] text-white rounded-xl font-semibold hover:bg-[#2F211C] transition">Submit Review</button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="cart-page" class="bg-FAF0E6 py-10">
            <div class="max-w-7xl mx-auto px-6">
                <h1 class="text-4xl font-extrabold text-[#4A352D] mb-8 border-b pb-4">Your Shopping Cart</h1>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <div class="lg:col-span-2 space-y-4">
                        <p id="cart-empty-message" class="text-xl text-gray-500 p-8 bg-white rounded-xl shadow-md text-center hidden">Your cart is currently empty. Start shopping now!</p>
                        <div id="cart-items-list" class="space-y-4">
                            </div>
                    </div>
                    
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl h-fit sticky top-24 border border-gray-100">
                        <h2 class="text-2xl font-bold text-[#4A352D] mb-4 border-b pb-3">Order Summary</h2>
                        
                        <div class="space-y-2 text-lg mb-6">
                            <div class="flex justify-between">
                                <span>Items (<span id="summary-item-count">0</span>):</span>
                                <span id="summary-subtotal">₹0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tax (18%):</span>
                                <span id="summary-tax">₹0.00</span>
                            </div>
                            <div class="flex justify-between font-bold text-xl pt-3 border-t">
                                <span>Grand Total:</span>
                                <span id="summary-grand-total" class="text-red-600">₹0.00</span>
                            </div>
                        </div>
                        
                        <button onclick="alert('Checkout process initiated!')" class="w-full bg-[#4A352D] text-white py-3 rounded-xl font-bold text-lg hover:bg-[#2F211C] transition shadow-lg mb-4">Proceed to Checkout</button>
                        <button id="paytmBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-blue-700 transition shadow-lg">Pay with Paytm (Mock)</button>
                    </div>

                </div>
            </div>
        </div>

        <div id="order-history-page" class="bg-FAF0E6 py-10">
            <div class="max-w-7xl mx-auto px-6">
                <h1 class="text-4xl font-extrabold text-[#4A352D] mb-8 border-b pb-4">Your Order History</h1>
                
                <p id="order-history-empty-message" class="text-xl text-gray-500 p-8 bg-white rounded-xl shadow-md text-center hidden">You haven't placed any orders yet.</p>
                <div id="orders-list-container" class="space-y-6">
                    </div>
            </div>
        </div>

    </main>

    <footer class="bg-[#4A352D] text-white py-10 mt-12">
        <div class="max-w-7xl mx-auto px-6 grid grid-cols-2 md:grid-cols-4 gap-8">
            <div>
                <h4 class="text-xl font-bold mb-4">IYAL</h4>
                <p class="text-sm text-gray-400">Pure. Potent. Traditional.</p>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li><a href="javascript:void(0)" onclick="goHomeAndScroll(1)" class="hover:text-white transition">Shop Products</a></li>
                    <li><a href="javascript:void(0)" onclick="viewOrderHistory()" class="hover:text-white transition">My Orders</a></li>
                    <li><a href="javascript:void(0)" onclick="goHomeAndScroll(2)" class="hover:text-white transition">About Us</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-4">Support</h4>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li><a href="#" class="hover:text-white transition">FAQ</a></li>
                    <li><a href="#" class="hover:text-white transition">Shipping</a></li>
                    <li><a href="#" class="hover:text-white transition">Returns</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-4">Connect</h4>
                <p class="text-sm text-gray-400">Email: support@iyal.in</p>
                <div class="flex space-x-4 mt-3">
                    </div>
            </div>
        </div>
        <div class="text-center text-sm text-gray-500 mt-10 border-t border-gray-700 pt-6">
            &copy; 2025 Iyal. All rights reserved.
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence, 
                 createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // *** getDocs IMPORTED FOR REAL ORDER FETCHING ***
        import { getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug'); // Enable Firebase logging for debugging in the console

        // --- Firebase Global Variables ---
        const appId = "iyal-app" ; 
        
        const firebaseConfig = {
          apiKey: "AIzaSyA5hPlKdqNi1FmAlVFmIXezZxot9-BuWeA", 
          authDomain: "iyal-59a03.firebaseapp.com",     
          projectId: "iyal-59a03",                      
          storageBucket: "iyal-59a03.firebasestorage.app",
          messagingSenderId: "714618123459",
          appId: "1:714618123459:web:ae86588468119322bd1e76",
          measurementId: "G-0GZSM3CDME"
        }; 

        const initialAuthToken = null;

        let db, auth, userId = null;
        let isAuthReady = false;
        let cartItems = []; 
        let currentProductId = null; 
        let authMode = 'login'; 
        let currentUser = null; 

        // --- Product Data Mock API (Kept for product details) ---
        const PRODUCTS = {
            'oil_magic': { id: 'oil_magic', name: 'Magic Hair Oil', price: 300, stock: 120, avgRating: 4.8, reviews: 45, delivery: '3-5 business days', image: 'https://placehold.co/600x600/8B4513/ffffff?text=Magic+Oil', description: "Iyal's Magic Hair Oil is a potent, time-tested blend of 12 natural herbs, cold-pressed with virgin coconut oil...", specs: ['Virgin Coconut Oil Base', 'Amla (Indian Gooseberry)', 'Bhringraj (False Daisy)', 'Hibiscus Flower Extracts', 'No Artificial Scents or Colors'], mockReviews: [{ name: 'Priya S.', rating: 5, comment: 'Absolutely transformed my hair!' }, { name: 'Ravi M.', rating: 4, comment: 'Great product, but the earthy smell is quite strong.' }] },
            'face_pack': { id: 'face_pack', name: 'Iyal Face Pack', price: 150, stock: 0, avgRating: 4.2, reviews: 22, delivery: 'Currently unavailable', image: 'https://placehold.co/600x600/696969/ffffff?text=Iyal+Face+Pack', description: "This purifying face pack is made with volcanic clay and activated charcoal to draw out deep-seated impurities...", specs: ['Volcanic Clay', 'Activated Charcoal', 'Pure Sandalwood Powder', 'Rose Water', 'Suitable for All Skin Types'], mockReviews: [{ name: 'Kavya T.', rating: 5, comment: 'My favorite! Gives a spa-like glow instantly.' }, { name: 'Arun V.', rating: 3, comment: 'A little drying on my combination skin.' }] },
            'health_mix': { id: 'health_mix', name: 'Iyal Health Mix', price: 350, stock: 450, avgRating: 4.9, reviews: 78, delivery: '2-4 business days', image: 'https://placehold.co/600x600/9ACD32/ffffff?text=Iyal+Mix', description: "A nutritious powerhouse, this daily health mix is a blend of 18 roasted grains, pulses, and nuts...", specs: ['Multi-Grain Blend (Ragi, Bajra, Wheat)', 'Pulses (Moong, Chana)', 'Dry Fruits (Almonds, Cashews)', 'No Added Sugar', 'High in Dietary Fiber'], mockReviews: [{ name: 'Deepak J.', rating: 5, comment: 'Perfect start to my day.' }, { name: 'Shreya P.', rating: 5, comment: 'My kids love this mixed with jaggery.' }] },
            'oil_pain': { id: 'oil_pain', name: 'Iyal Pain Relief Oil', price: 175, stock: 250, avgRating: 4.5, reviews: 31, delivery: '4-6 business days', image: 'https://placehold.co/600x600/800000/ffffff?text=Iyal+Oil', description: "Experience fast, deep relief from muscle aches, joint stiffness, and chronic pain. Our Pain Relief Oil uses traditional ayurvedic wisdom...", specs: ['Sesame Oil Base', 'Wintergreen Oil', 'Eucalyptus Oil', 'Camphor', 'Rapid Penetration Formula'], mockReviews: [{ name: 'Vimal K.', rating: 4, comment: 'Very effective for my knee pain after running.' }, { name: 'Leena R.', rating: 5, comment: 'Best pain relief oil I have ever used.' }] }
        };

        // --- DOM Elements ---
        const mainHeader = document.getElementById('main-header');
        const mainLandingContent = document.getElementById('main-landing-content');
        const productDetailPage = document.getElementById('product-detail-page');
        const cartPage = document.getElementById('cart-page');
        const orderHistoryPage = document.getElementById('order-history-page'); 

        const cartItemsListElement = document.getElementById('cart-items-list');
        const cartCountDesktop = document.getElementById('cart-count');
        const cartCountMobile = document.getElementById('mobile-cart-count');
        
        const authModal = document.getElementById('auth-modal');
        const authTitle = document.getElementById('auth-title');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authToggleButton = document.getElementById('auth-toggle-button');
        const authError = document.getElementById('auth-error');
        const authErrorMessage = document.getElementById('auth-error-message');
        const userStatusElement = document.getElementById('current-user-status');
        const authActionButton = document.getElementById('auth-action-button');
        const signoutButton = document.getElementById('signout-button');
        const mobileAuthText = document.getElementById('mobile-auth-text');
        const ordersListContainer = document.getElementById('orders-list-container');
        const orderHistoryEmptyMessage = document.getElementById('order-history-empty-message');


        // --- FIREBASE INITIALIZATION AND AUTH ---
        async function setupFirebaseAndAuth() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config missing API Key.");
                userStatusElement.textContent = 'Firebase Error: Config Missing Key';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                 console.error("Firebase Initialization Failed (Check Config Casing!):", error);
                 userStatusElement.textContent = `Init Error: ${error.message || 'Check config casing.'}`;
                 return; 
            }
            

            try {
                // Set persistence to local to remember the session
                await setPersistence(auth, browserLocalPersistence);
                
                // Sign in with custom token if available. 
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } 

                // Main Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // Update UI based on user type
                        if (user.email) {
                            // Email/Password User (potentially unverified)
                            if (user.emailVerified) {
                                userStatusElement.innerHTML = `Signed in as: <span class="font-bold text-green-300">${user.email}</span>`;
                                authActionButton.classList.add('hidden');
                                signoutButton.classList.remove('hidden');
                                mobileAuthText.textContent = 'Sign Out';
                            } else {
                                // Email/Password User - Unverified
                                userStatusElement.innerHTML = `Email: ${user.email} (<span class="text-red-400 font-bold">Unverified</span>)`;
                                authActionButton.textContent = 'Resend Verification';
                                authActionButton.onclick = sendVerificationEmail;
                                authActionButton.classList.remove('hidden');
                                signoutButton.classList.remove('hidden');
                                mobileAuthText.textContent = 'Sign Out';
                            }
                        } else {
                            // Anonymous or Token User
                            userStatusElement.innerHTML = `Guest User ID: <span class="font-bold">${user.uid.substring(0, 8)}...</span>`;
                            authActionButton.textContent = 'Login / Sign Up';
                            authActionButton.onclick = showLoginModal;
                            authActionButton.classList.remove('hidden');
                            signoutButton.classList.add('hidden'); // Cannot sign out anon user authenticated via token
                            mobileAuthText.textContent = 'Login / Sign Up';
                        }
                        
                        listenToCart(); 
                    } else {
                        // Signed out
                        userId = null;
                        isAuthReady = false;
                        userStatusElement.textContent = 'Signed Out.';
                        authActionButton.textContent = 'Login / Sign Up';
                        authActionButton.onclick = showLoginModal;
                        authActionButton.classList.remove('hidden');
                        signoutButton.classList.add('hidden');
                        mobileAuthText.textContent = 'Login / Sign Up';
                        cartItems = [];
                        updateCartUI();
                    }
                });

            } catch (error) {
                console.error("Firebase Auth or Init error:", error);
                // Handle the case where the config itself is bad (often logs 'undefined' error)
                userStatusElement.textContent = `Auth Error: ${error.code || 'Initialization Failed'}`;
            }
        }

        /**
         * Sends the verification email to the current user.
         */
        async function sendVerificationEmail() {
            if (!currentUser) return;
            try {
                await sendEmailVerification(currentUser);
                // NOTE: Using a custom alert instead of window.alert()
                console.log("Verification email successfully sent.");
                document.getElementById('auth-error-message').textContent = "Verification email sent! Please check your inbox and spam folder.";
                document.getElementById('auth-error').classList.remove('hidden');
                setTimeout(() => document.getElementById('auth-error').classList.add('hidden'), 5000);
            } catch (error) {
                console.error("Error sending verification email:", error);
                document.getElementById('auth-error-message').textContent = `Error sending verification email: ${error.message}. Please try again later.`;
                document.getElementById('auth-error').classList.remove('hidden');
            }
        }
        
        /**
         * Signs out the currently authenticated user.
         */
        async function signOutUser() {
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
                goHome();
                // NOTE: The onAuthStateChanged listener handles the UI update
            } catch (error) {
                console.error("Error signing out:", error);
                document.getElementById('auth-error-message').textContent = `Sign out failed: ${error.message}`;
                document.getElementById('auth-error').classList.remove('hidden');
            }
        }

        // --- AUTH MODAL LOGIC (functions kept as is) ---
        
        function showLoginModal() {
            authModal.style.display = 'flex';
            authModal.classList.add('active');
            // Hide any previous error messages
            authError.classList.add('hidden');
            document.getElementById('auth-form').reset();
            toggleAuthMode('login'); // Default to login when showing
            toggleMobileMenu(true); // Close mobile menu if open
        }

        function hideLoginModal() {
            authModal.classList.remove('active');
            setTimeout(() => { authModal.style.display = 'none'; }, 300); // Wait for transition
        }

        function toggleAuthMode(mode) {
            authMode = mode || (authMode === 'login' ? 'signup' : 'login');
            
            if (authMode === 'login') {
                authTitle.textContent = 'Login';
                authSubmitButton.textContent = 'Login';
                authToggleButton.innerHTML = 'New user? Click here to **Sign Up**';
            } else {
                authTitle.textContent = 'Sign Up';
                authSubmitButton.textContent = 'Sign Up';
                authToggleButton.innerHTML = 'Already have an account? Click here to **Login**';
            }
        }

        async function handleAuthSubmit() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            authError.classList.add('hidden');
            authErrorMessage.textContent = '';
            
            // Client-side validation for empty/invalid fields
            if (!email || !password || password.length < 6) {
                authErrorMessage.textContent = "Please ensure both a valid email and a password (minimum 6 characters) are entered correctly.";
                authError.classList.remove('hidden');
                return; // Stop execution if inputs are invalid
            }
            
            try {
                if (authMode === 'signup') {
                    // 1. Create the user
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // 2. Send verification email
                    await sendEmailVerification(user);
                    
                    // Display success message in the modal before closing
                    authErrorMessage.textContent = `Signup successful! A verification email has been sent to ${email}. Please verify your email to fully activate your account.`;
                    authError.classList.remove('hidden');
                    
                    // Wait a moment then close the modal
                    setTimeout(() => {
                        hideLoginModal();
                        // Firebase will automatically sign in the user after signup.
                    }, 3000); 

                } else {
                    // Login
                    await signInWithEmailAndPassword(auth, email, password);
                    hideLoginModal();
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                
                // Robust error handling
                if (error.code) {
                    authErrorMessage.textContent = getAuthErrorMessage(error.code);
                } else {
                    // This catches any remaining generic error
                    authErrorMessage.textContent = "A critical error occurred. Please ensure your network is stable and the Firebase configuration is exactly correct.";
                }

                authError.classList.remove('hidden');
            }
        }
        
        function getAuthErrorMessage(code) {
            switch (code) {
                case 'auth/operation-not-allowed':
                    return 'Sign up/login failed. The **Email/Password sign-in method** is currently **disabled** in your Firebase Console. Please **enable it** under Authentication -> Sign-in method.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    return 'Invalid email or password.';
                case 'auth/email-already-in-use':
                    return 'This email is already in use. Try logging in.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/invalid-email':
                    return 'The email address is not valid.';
                case 'auth/too-many-requests':
                    return 'Access to this account has been temporarily blocked due to too many failed login attempts. Please try again later.';
                default:
                    // If the code is still unknown, use the generic message
                    return `An unknown error occurred. (Code: ${code})`;
            }
        }

        function handleMobileAuthAction() {
            toggleMobileMenu(true);
            if (currentUser && currentUser.email) {
                // If logged in via email, mobile button is for sign out
                signOutUser();
            } else {
                // If guest/token user, mobile button is for login/signup
                showLoginModal();
            }
        }


        // --- Firestore/Cart Functions ---

        function getCartCollectionRef() {
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/cart_items`);
        }
        
        /**
         * Fetches the real order data for the current user from Firestore.
         */
        async function fetchUserOrders() {
            if (!db || !userId) {
                console.error("Cannot fetch orders: Database or User ID not ready.");
                return []; 
            }
            const ordersRef = getOrdersCollectionRef();
            if (!ordersRef) return [];
            
            try {
                // Fetch all documents from the user's orders collection
                const querySnapshot = await getDocs(ordersRef); 
                
                const realOrders = querySnapshot.docs.map(doc => ({
                    id: doc.id, // Firestore document ID is the Order ID
                    ...doc.data()
                }));
                
                // Optional: Sort by date (assuming a 'date' field exists, newest first)
                // realOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

                return realOrders;

            } catch (e) {
                console.error("Error fetching user orders:", e);
                return []; 
            }
        }

        function getOrdersCollectionRef() {
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return null;
            }
            // This is the correct collection path for user-specific orders
            return collection(db, `artifacts/${appId}/users/${userId}/orders`);
        }

        function listenToCart() {
            const cartRef = getCartCollectionRef();
            if (!cartRef) return;

            onSnapshot(cartRef, (snapshot) => {
                const newCartItems = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const productDetails = PRODUCTS[data.productId];
                    if (productDetails) {
                        newCartItems.push({
                            id: doc.id, 
                            ...data,
                            ...productDetails
                        });
                    }
                });
                cartItems = newCartItems;
                updateCartUI();
                renderCartPage();
            }, (error) => {
                console.error("Error listening to cart changes:", error);
            });
        }

        function updateCartUI() {
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            
            cartCountDesktop.textContent = totalItems;
            cartCountMobile.textContent = totalItems;

            if (totalItems > 0) {
                cartCountDesktop.classList.remove('hidden');
            } else {
                cartCountDesktop.classList.add('hidden');
            }
        }

        async function addToCart(productId) {
            // Check if user is verified before allowing adding to cart
            if (!currentUser || (currentUser.email && !currentUser.emailVerified)) {
                // Display error feedback on the screen instead of using alert
                document.getElementById('auth-error-message').textContent = "Please log in and verify your email address to add items to your cart.";
                document.getElementById('auth-error').classList.remove('hidden');
                showLoginModal();
                return;
            }
            
            if (!isAuthReady) {
                console.error("Authentication not ready. Cannot add to cart.");
                return;
            }

            const product = PRODUCTS[productId];
            if (!product || product.stock <= 0) {
                console.warn(`Product ${productId} is out of stock.`);
                return;
            }
            
            const existingItem = cartItems.find(item => item.productId === productId);
            const cartRef = getCartCollectionRef();

            try {
                if (existingItem) {
                    const itemDocRef = doc(cartRef, existingItem.id);
                    await updateDoc(itemDocRef, {
                        quantity: existingItem.quantity + 1,
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    await addDoc(cartRef, {
                        productId: productId,
                        quantity: 1,
                        addedAt: new Date().toISOString()
                    });
                }
                
                const detailButton = document.querySelector(`#product-detail-page button[onclick="addToCart('${productId}')"]`);
                showTemporaryFeedback(detailButton, 'Added to Cart!', 'bg-green-600');

            } catch (e) {
                console.error("Error adding/updating cart item:", e);
                const detailButton = document.querySelector(`#product-detail-page button[onclick="addToCart('${productId}')"]`);
                showTemporaryFeedback(detailButton, 'Error!', 'bg-red-600');
            }
        }
        
        async function removeItem(cartItemId) {
            if (!isAuthReady) return;
            const cartRef = getCartCollectionRef();
            const itemDocRef = doc(cartRef, cartItemId);
            try { await deleteDoc(itemDocRef); } catch (e) { console.error("Error removing cart item:", e); }
        }

        async function updateQuantity(cartItemId, newQuantity) {
            if (!isAuthReady) return;
            const quantity = parseInt(newQuantity);
            if (quantity < 1 || isNaN(quantity)) { return removeItem(cartItemId); }
            const cartRef = getCartCollectionRef();
            const itemDocRef = doc(cartRef, cartItemId);
            try {
                await updateDoc(itemDocRef, { quantity: quantity, updatedAt: new Date().toISOString() });
            } catch (e) { console.error("Error updating quantity:", e); }
        }

        // --- Navigation and UI State ---
        
        function renderCartPage() { 
            if (!isAuthReady || !cartItemsListElement) return;
            let totalItems = 0; let subtotal = 0;
            const cartEmptyMessage = document.getElementById('cart-empty-message');
            if (cartItems.length === 0) { 
                cartEmptyMessage.style.display = 'block'; 
                cartItemsListElement.innerHTML = ''; 
            } else { 
                cartEmptyMessage.style.display = 'none';
                cartItemsListElement.innerHTML = cartItems.map(item => {
                    const itemTotal = item.price * item.quantity; subtotal += itemTotal; totalItems += item.quantity;
                    return `<div class="flex flex-col sm:flex-row items-start sm:items-center p-4 bg-white rounded-xl shadow-md border border-gray-200"><img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-contain rounded-lg flex-shrink-0 mr-4 border border-gray-100"><div class="flex-grow my-2 sm:my-0"><h3 class="text-xl font-semibold text-[#4A352D]">${item.name}</h3><p class="text-gray-500">Price: ₹${item.price.toFixed(2)}</p></div><div class="flex items-center space-x-4 mt-3 sm:mt-0 sm:ml-auto"><div class="flex items-center border border-gray-300 rounded-full overflow-hidden"><button onclick="updateQuantity('${item.id}', ${item.quantity - 1})" class="p-2 w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-lg font-bold transition rounded-l-full">&minus;</button><input type="number" value="${item.quantity}" min="1" onchange="updateQuantity('${item.id}', this.value)" class="w-12 text-center text-lg border-x border-gray-300 focus:outline-none focus:ring-0 appearance-none bg-white"><button onclick="updateQuantity('${item.id}', ${item.quantity + 1})" class="p-2 w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-lg font-bold transition rounded-r-full">&#43;</button></div><div class="text-xl font-bold w-24 text-right">₹${itemTotal.toFixed(2)}</div><button onclick="removeItem('${item.id}')" class="text-red-500 hover:text-red-700 transition p-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></button></div></div>`;
                }).join('');
            }
            const taxRate = 0.18; 
            const taxAmount = subtotal * taxRate; 
            const grandTotal = subtotal + taxAmount;
            document.getElementById('summary-item-count').textContent = totalItems; 
            document.getElementById('summary-subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('summary-tax').textContent = `₹${taxAmount.toFixed(2)}`; 
            document.getElementById('summary-grand-total').textContent = `₹${grandTotal.toFixed(2)}`;
        }
        
        /**
         * Renders the order history page using real data fetched from Firestore.
         */
        async function renderOrderHistoryPage() {
            if (!ordersListContainer) return;

            // Optional: Show loading state
            ordersListContainer.innerHTML = '<p class="text-center text-xl text-gray-500 p-8 bg-white rounded-xl shadow-md">Loading your orders...</p>';

            // Fetch the actual orders from Firestore
            const orders = await fetchUserOrders();
            
            if (orders.length === 0) { 
                orderHistoryEmptyMessage.style.display = 'block'; 
                ordersListContainer.innerHTML = ''; 
                return; 
            }
            
            orderHistoryEmptyMessage.style.display = 'none';
            ordersListContainer.innerHTML = orders.map(order => {
                let statusColor = 'text-gray-600'; 
                if (order.status === 'Delivered') statusColor = 'text-green-600 font-semibold'; 
                if (order.status === 'Shipped') statusColor = 'text-yellow-600 font-semibold'; 
                if (order.status === 'Processing') statusColor = 'text-blue-600 font-semibold';
                
                // Safely render item details
                const itemsList = Array.isArray(order.items) ? order.items.map(item => `<div class="flex justify-between text-sm text-gray-500 ml-4"><span>${item.quantity} x ${item.name}</span><span>₹${(item.price * item.quantity).toFixed(2)}</span></div>`).join('') : '<div class="text-sm text-red-500">No item details available.</div>';
                
                // Safely format total
                const totalDisplay = (typeof order.total === 'number') ? order.total.toFixed(2) : 'N/A';

                return `<div class="bg-white p-6 rounded-xl shadow-lg border border-[#B38B6D]/30 transition hover:shadow-xl"><div class="flex justify-between items-start pb-4 border-b border-gray-200 mb-4 flex-wrap"><div><h3 class="text-xl md:text-2xl font-bold text-[#4A352D]">Order ID: ${order.id}</h3><p class="text-sm text-gray-500">Placed on: ${order.date || 'Unknown Date'}</p></div><div class="mt-2 md:mt-0 text-right"><p class="text-2xl font-bold text-black">₹${totalDisplay}</p><p class="text-sm ${statusColor}">Status: ${order.status || 'Unknown'}</p></div></div><div class="space-y-2"><h4 class="text-lg font-semibold text-gray-700">Items Ordered:</h4>${itemsList}</div><div class="mt-6 pt-4 border-t border-gray-100 flex justify-end space-x-4"><button onclick="console.log('Tracking Order ${order.id}')" class="px-4 py-2 text-[#4A352D] border border-[#4A352D] rounded-full text-sm font-semibold hover:bg-[#4A352D] hover:text-white transition">Track Order</button><button onclick="console.log('Reordering Order ${order.id}')" class="px-4 py-2 bg-[#B38B6D] text-white rounded-full text-sm font-semibold hover:bg-[#9E785C] transition">Reorder</button></div></div>`;
            }).join('');
        }
        
        function viewCart() { 
            productDetailPage.style.display = 'none'; 
            orderHistoryPage.style.display = 'none'; 
            mainLandingContent.classList.add('hidden-page'); 
            cartPage.style.display = 'block'; 
            window.scrollTo(0, 0); 
            handleScroll(true); 
            toggleMobileMenu(true); 
        }
        
        function viewOrderHistory() { 
            productDetailPage.style.display = 'none'; 
            cartPage.style.display = 'none'; 
            mainLandingContent.classList.add('hidden-page'); 
            orderHistoryPage.style.display = 'block'; 
            renderOrderHistoryPage(); // <-- Calls the async function to fetch real data
            window.scrollTo(0, 0); 
            handleScroll(true); 
            toggleMobileMenu(true); 
        }
        
        function viewProduct(productId) { 
            currentProductId = productId; 
            const product = PRODUCTS[productId]; 
            if (!product) { 
                console.error(`Product with ID ${productId} not found.`); 
                return; 
            }
            document.getElementById('detail-title').textContent = product.name; 
            document.getElementById('detail-image').src = product.image; 
            document.getElementById('detail-image').alt = product.name + " Image"; 
            document.getElementById('detail-description').textContent = product.description; 
            document.getElementById('detail-price').textContent = `₹${product.price.toFixed(2)}`;
            
            const stockElement = document.getElementById('detail-stock'); 
            const deliveryElement = document.getElementById('detail-delivery').querySelector('span'); 
            const buyButtons = productDetailPage.querySelectorAll('.buy-button-style');
            
            if (product.stock > 0) { 
                stockElement.innerHTML = `<span class="text-green-600">&#10003; In Stock!</span> (${product.stock} left)`; 
                deliveryElement.textContent = product.delivery; 
                buyButtons.forEach(btn => btn.disabled = false); 
                buyButtons.forEach(btn => btn.classList.remove('opacity-50', 'cursor-not-allowed')); 
            } else { 
                stockElement.innerHTML = `<span class="text-red-600">&#10007; Out of Stock</span>`; 
                deliveryElement.textContent = 'Currently unavailable for delivery.'; 
                buyButtons.forEach(btn => btn.disabled = true); 
                buyButtons.forEach(btn => btn.classList.add('opacity-50', 'cursor-not-allowed')); 
            }
            
            const specsList = document.getElementById('detail-specs'); 
            // The next line splits the rating display to keep the count span intact.
            document.getElementById('detail-rating-display').innerHTML = renderStars(product.avgRating) + document.getElementById('detail-rating-display').innerHTML.split(')')[1];
            
            specsList.innerHTML = product.specs.map(item => `<li>${item}</li>`).join(''); 
            document.getElementById('detail-review-count').textContent = product.reviews; 
             
            const reviewsList = document.getElementById('detail-reviews-list'); 
            reviewsList.innerHTML = product.mockReviews.map(review => `<div class="border-b border-gray-200 pb-4"><div class="flex items-center mb-1">${renderStars(review.rating)}<span class="ml-4 font-semibold text-lg">${review.name}</span></div><p class="text-gray-600 italic">"${review.comment}"</p></div>`).join('');
            
            // --- Navigation Fixes for Robustness ---
            mainLandingContent.classList.add('hidden-page'); 
            cartPage.style.display = 'none'; 
            orderHistoryPage.style.display = 'none'; 
            productDetailPage.style.display = 'block'; // **Ensures the page is displayed**
            
            window.scrollTo(0, 0); 
            mainHeader.classList.add('bg-[#4A352D]', 'shadow-md');
        }
        
        function goHome() { 
            productDetailPage.style.display = 'none';
            cartPage.style.display = 'none';
            orderHistoryPage.style.display = 'none'; 
            mainLandingContent.classList.remove('hidden-page');
            window.scrollTo(0, 0); 
            handleScroll(); 
        }
        
        function goHomeAndScroll(sectionIndex) { 
            productDetailPage.style.display = 'none';
            cartPage.style.display = 'none';
            orderHistoryPage.style.display = 'none'; 
            mainLandingContent.classList.remove('hidden-page');
            scrollToSection(sectionIndex);
            setTimeout(() => toggleMobileMenu(true), 300); // Pass true to force close
            handleScroll();
        }
        
        function handleScroll(forceDark = false) {
            if (mainLandingContent.classList.contains('hidden-page') && !forceDark) {
                mainHeader.classList.add('bg-[#4A352D]', 'shadow-md'); document.querySelectorAll('#cart-icon, #mobile-menu-toggle svg').forEach(el => el.setAttribute('stroke', 'white')); return;
            }
            const scrollY = window.scrollY; const viewportHeight = window.innerHeight;
            const isScrolledToProductSection = scrollY >= (viewportHeight * 0.5);
            if (isScrolledToProductSection) {
                mainHeader.classList.add('bg-[#4A352D]', 'shadow-md'); document.querySelectorAll('#cart-icon, #mobile-menu-toggle svg').forEach(el => el.setAttribute('stroke', 'white'));
            } else {
                mainHeader.classList.remove('bg-[#4A352D]', 'shadow-md'); document.querySelectorAll('#cart-icon, #mobile-menu-toggle svg').forEach(el => el.setAttribute('stroke', 'white'));
            }
        }
        
        function renderStars(rating) {
            let starsHtml = ''; 
            const fullStars = Math.floor(rating); 
            const halfStar = rating % 1 !== 0; 
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            for (let i = 0; i < fullStars; i++) { starsHtml += `<span class="star-filled text-2xl">&#9733;</span>`; }
            if (halfStar) { starsHtml += `<span class="star-filled text-2xl">&#9733;</span>`; }
            for (let i = 0; i < emptyStars; i++) { starsHtml += `<span class="star-empty text-2xl">&#9733;</span>`; }
            
            starsHtml += `<span class="text-xl font-bold ml-3 text-[#4A352D]">${rating.toFixed(1)}</span>`;
            return starsHtml;
        }

        // --- Scrolling & Animation Utilities ---
        function easeInOutQuint(t) { return t < 0.5 ? 16 * t * t * t * t * t : 1 + 16 * (--t) * t * t * t * t; }
        
        function animateScroll(targetY, duration) {
            const startY = window.scrollY;
            const distance = targetY - startY;
            let startTime = null;

            function step(currentTime) {
                if (startTime === null) startTime = currentTime;
                const timeElapsed = currentTime - startTime;
                const progress = Math.min(timeElapsed / duration, 1);
                const easedProgress = easeInOutQuint(progress);

                window.scrollTo(0, startY + distance * easedProgress);

                if (timeElapsed < duration) {
                    window.requestAnimationFrame(step);
                }
            }

            window.requestAnimationFrame(step);
        }

        function scrollToSection(index) {
            const sections = document.querySelectorAll('.snap-section');
            if (index >= 0 && index < sections.length) {
                const targetSection = sections[index];
                const targetY = targetSection.offsetTop - mainHeader.offsetHeight;
                animateScroll(targetY, 800);
            }
        }

        function toggleMobileMenu(forceClose = false) {
            const menu = document.getElementById('mobile-menu');
            const body = document.body;
            
            if (forceClose || menu.classList.contains('translate-x-0')) {
                menu.classList.remove('translate-x-0');
                menu.classList.add('translate-x-full');
                body.classList.remove('overflow-hidden');
            } else {
                menu.classList.remove('translate-x-full');
                menu.classList.add('translate-x-0');
                body.classList.add('overflow-hidden');
            }
        }

        function showTemporaryFeedback(element, message, bgColorClass) {
            const originalText = element.textContent;
            const originalClasses = element.className;

            element.textContent = message;
            element.classList.add(bgColorClass);
            element.classList.remove('bg-[#B38B6D]', 'hover:bg-[#9E785C]');
            
            setTimeout(() => {
                element.textContent = originalText;
                element.className = originalClasses; // Restore original classes completely
            }, 1500);
        }

        function handleReviewSubmit(event) {
            event.preventDefault();
            const name = document.getElementById('review-name').value;
            const rating = document.getElementById('review-rating').value;
            const comment = document.getElementById('review-comment').value;
            
            // Mock API: In a real app, this would post to Firestore/Backend
            console.log(`Submitting Review for Product ID ${currentProductId}: Name=${name}, Rating=${rating}, Comment=${comment}`);
            
            alert('Review submitted successfully (Mock)!');
            event.target.reset(); 
            // In a real app, you would refresh the product view or append the new review.
        }

        // --- Global Exports ---
        window.goHome = goHome;
        window.viewProduct = viewProduct;
        window.viewCart = viewCart;
        window.viewOrderHistory = viewOrderHistory;
        window.addToCart = addToCart;
        window.removeItem = removeItem;
        window.updateQuantity = updateQuantity;
        window.toggleMobileMenu = toggleMobileMenu;
        window.goHomeAndScroll = goHomeAndScroll;
        window.handleReviewSubmit = handleReviewSubmit;
        window.scrollToSection = scrollToSection;
        window.showLoginModal = showLoginModal; 
        window.hideLoginModal = hideLoginModal; 
        window.toggleAuthMode = toggleAuthMode; 
        window.handleAuthSubmit = handleAuthSubmit; 
        window.signOutUser = signOutUser; 
        window.sendVerificationEmail = sendVerificationEmail; 
        window.handleMobileAuthAction = handleMobileAuthAction; 

        // --- Initialization ---

        window.onload = () => {
            setupFirebaseAndAuth();

            // Loading Overlay animation
            const loadingOverlay = document.getElementById('loading-overlay');
            const iyalTextContainer = document.getElementById('iyal-intro-text');
            const chars = iyalTextContainer.querySelectorAll('.intro-char');
            const staggerDelay = 200; 
            let totalRevealTime = chars.length * staggerDelay; 
            
            chars.forEach((char, index) => {
                setTimeout(() => {
                    char.classList.add('visible');
                }, index * staggerDelay);
            });
            
            setTimeout(() => {
                loadingOverlay.classList.add('hidden-load');
            }, totalRevealTime + 200); 
            
            // Attach Listeners
            window.addEventListener('scroll', () => handleScroll());
            handleScroll(); // Initial check
        };
        
    </script>
</body>
</html>
